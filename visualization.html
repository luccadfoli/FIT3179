<!DOCTYPE html>
<html>
<head>
  <script src="https://cdn.jsdelivr.net/npm/vega@6.2.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-lite@6.1.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-embed@7.0.2"></script>
</head>
<body>
  <div id="vis"/>
  <script>
    const spec = {
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
  "width": 600,
  "height": 500,
  "projection": {
    "type": "conicEqualArea",
    "parallels": [-18, -36],
    "center": [134, -25],
    "rotate": [0, 0, 0],
    "scale": 700
  },
  "layer": [
    {
      "data": {
        "url": "https://raw.githubusercontent.com/luccadfoli/FIT3179/main/STE_2021_AUST_GDA2020.json",
        "format": {"type": "topojson", "feature": "STE_2021_AUST_GDA2020"}
      },
      "transform": [
        {
          "lookup": "properties.STE_NAME21",
          "from": {
            "data": {
              "url": "https://raw.githubusercontent.com/luccadfoli/FIT3179/main/electricity_by_state.csv"
            },
            "key": "State",
            "fields": ["2023–24 PJ ", "2023–24 PJ"]
          }
        },
        {
          "calculate": "isValid(datum['2023–24 PJ ']) ? datum['2023–24 PJ '] : datum['2023–24 PJ']",
          "as": "pj_raw"
        },
        {
          "calculate": "toNumber(replace(replace(replace(replace(replace(datum.pj_raw, ',', ''), '\\u00A0', ''), '\\u202F', ''), ' ', ''), '\\t', '')) * 277.778",
          "as": "electricity_gwh"
        },
        {
          "lookup": "properties.STE_NAME21",
          "from": {
            "data": {
              "url": "https://raw.githubusercontent.com/luccadfoli/FIT3179/main/Annual%20population%20change%20at%2031%20March%202025.csv"
            },
            "key": "State",
            "fields": ["Population at 31 March 2025"]
          }
        },
        {
          "calculate": "toNumber(replace(datum['Population at 31 March 2025'], ',', '')) * 1000",
          "as": "pop_2025"
        },
        {
          "calculate": "(isValid(datum.electricity_gwh) && isValid(datum.pop_2025) && datum.pop_2025>0) ? datum.electricity_gwh / datum.pop_2025 : null",
          "as": "gwh_per_capita"
        }
      ],
      "mark": {"type": "geoshape"},
      "encoding": {
        "color": {
          "field": "gwh_per_capita",
          "type": "quantitative",
          "title": "GWh per person"
        },
        "tooltip": [
          {"field": "properties.STE_NAME21", "title": "State"},
          {
            "field": "electricity_gwh",
            "type": "quantitative",
            "title": "Electricity (GWh)",
            "format": ",.0f"
          },
          {
            "field": "pop_2025",
            "type": "quantitative",
            "title": "Population",
            "format": ",.0f"
          },
          {
            "field": "gwh_per_capita",
            "type": "quantitative",
            "title": "GWh per person",
            "format": ".6f"
          }
        ],
        "stroke": {
          "condition": {
            "test": "isValid(datum.gwh_per_capita)",
            "value": "#98a7b6"
          },
          "value": "red"
        },
        "strokeWidth": {
          "condition": {"test": "isValid(datum.gwh_per_capita)", "value": 0.8},
          "value": 2
        }
      }
    }
  ],
  "title": "Electricity per Capita by State — Australia",
  "config": {}
};
    vegaEmbed("#vis", spec, {mode: "vega-lite"}).then(console.log).catch(console.warn);
  </script>
</body>
</html>
